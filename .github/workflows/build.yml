name: æ‰“åŒ…åº”ç”¨ç¨‹åº

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: æ‰“åŒ…exe
        run: |
          pyinstaller --name="è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ" --windowed --onefile --add-data "yolov8m-pose.pt;." --hidden-import=cv2 --hidden-import=torch --hidden-import=ultralytics --hidden-import=PyQt6 --hidden-import=PyQt6.QtCore --hidden-import=PyQt6.QtGui --hidden-import=PyQt6.QtWidgets --collect-all PyQt6 --collect-all ultralytics --collect-all torch --copy-metadata torch --copy-metadata tqdm --copy-metadata regex --copy-metadata packaging --copy-metadata filelock --copy-metadata numpy --copy-metadata pillow gui_main.py

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: dist/è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ.exe

  build-macos:
    runs-on: macos-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®Pythonç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: æ‰“åŒ…app
        run: |
          pyinstaller --name="è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ" \
                      --windowed \
                      --onefile \
                      --add-data "yolov8m-pose.pt:." \
                      --hidden-import=cv2 \
                      --hidden-import=torch \
                      --hidden-import=ultralytics \
                      --hidden-import=PyQt6 \
                      --hidden-import=PyQt6.QtCore \
                      --hidden-import=PyQt6.QtGui \
                      --hidden-import=PyQt6.QtWidgets \
                      --collect-all PyQt6 \
                      --collect-all ultralytics \
                      --collect-all torch \
                      --copy-metadata torch \
                      --copy-metadata tqdm \
                      --copy-metadata regex \
                      --copy-metadata packaging \
                      --copy-metadata filelock \
                      --copy-metadata numpy \
                      --copy-metadata pillow \
                      gui_main.py

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: macos-app
          path: dist/è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ

  create-release:
    needs: [build-windows, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: ä¸‹è½½Windowsæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: ./windows

      - name: ä¸‹è½½macOSæ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: macos-app
          path: ./macos

      - name: å‹ç¼©æ–‡ä»¶
        run: |
          cd windows
          zip -r ../è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-Windows.zip .
          cd ../macos
          zip -r ../è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-macOS.zip .
          cd ..

      - name: åˆ›å»ºRelease
        uses: softprops/action-gh-release@v1
        with:
          files: |
            è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-Windows.zip
            è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-macOS.zip
          body: |
            ## è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ ${{ github.ref_name }}

            ### ğŸ‰ æ–°åŠŸèƒ½
            - âœ… PyQt6æ¡Œé¢GUIç•Œé¢
            - âœ… è§†é¢‘åœ¨çº¿é¢„è§ˆï¼ˆæ”¯æŒæ’­æ”¾æ§åˆ¶ã€å€é€Ÿã€è·³å¸§ï¼‰
            - âœ… ç»Ÿè®¡å›¾è¡¨å¯è§†åŒ–
            - âœ… è¯¦ç»†æŠ¥å‘Šå±•ç¤º
            - âœ… CSVæ•°æ®å¯¼å‡º

            ### ğŸ“¥ ä¸‹è½½è¯´æ˜

            **Windowsç”¨æˆ·**:
            1. ä¸‹è½½ `è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-Windows.zip`
            2. è§£å‹åè¿è¡Œ `è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ.exe`

            **macOSç”¨æˆ·**:
            1. ä¸‹è½½ `è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ-macOS.zip`
            2. è§£å‹åè¿è¡Œ `è¯¾å ‚ä¸“æ³¨åº¦æ£€æµ‹ç³»ç»Ÿ`
            3. å¦‚æœæç¤º"æ— æ³•éªŒè¯å¼€å‘è€…"ï¼Œå³é”®ç‚¹å‡» -> æ‰“å¼€

            ### ğŸ“– ä½¿ç”¨æ–‡æ¡£
            è¯¦è§é¡¹ç›®READMEå’Œdocsæ–‡ä»¶å¤¹
          draft: false
          prerelease: false

